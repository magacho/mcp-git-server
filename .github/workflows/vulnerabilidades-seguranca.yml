name: Testes de Vulnerabilidades e Seguranca

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  issues: write

jobs:
  security:
    name: An√°lise de Seguran√ßa
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install safety bandit pip-audit
    
    - name: Run Bandit Security Scan
      run: |
        bandit -r . -f json -o bandit-report.json || true
        bandit -r . -f txt
      continue-on-error: true
    
    - name: Run Safety Check
      run: |
        safety check --json --output safety-report.json || true
        safety check || true
      continue-on-error: true
    
    - name: Run pip-audit
      run: |
        pip-audit --format json --output pip-audit-report.json || true
        pip-audit || true
      continue-on-error: true
    
    - name: Upload security reports
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json
          pip-audit-report.json
    
    - name: Evaluate security results
      id: evaluate
      run: |
        HAS_ISSUES=false
        
        if [ -f bandit-report.json ]; then
          BANDIT_ISSUES=$(python -c "import json; data=json.load(open('bandit-report.json')); print(len([r for r in data.get('results', []) if r.get('issue_severity') in ['HIGH', 'MEDIUM']]))")
          echo "Bandit encontrou $BANDIT_ISSUES problemas"
          if [ "$BANDIT_ISSUES" -gt "0" ]; then
            HAS_ISSUES=true
          fi
        fi
        
        if [ -f safety-report.json ]; then
          SAFETY_ISSUES=$(python -c "import json; data=json.load(open('safety-report.json')); print(len(data.get('vulnerabilities', [])))" 2>/dev/null || echo "0")
          echo "Safety encontrou $SAFETY_ISSUES vulnerabilidades"
          if [ "$SAFETY_ISSUES" -gt "0" ]; then
            HAS_ISSUES=true
          fi
        fi
        
        echo "has_issues=$HAS_ISSUES" >> $GITHUB_OUTPUT
    
    - name: Create security issue
      if: steps.evaluate.outputs.has_issues == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          let issuesFound = [];
          let detailedInfo = [];
          
          // Mapeamento de solu√ß√µes para problemas comuns do Bandit
          const banditSolutions = {
            'B201': {
              title: 'Uso de flask com debug=True',
              risk: 'Exp√µe informa√ß√µes sens√≠veis e permite execu√ß√£o remota de c√≥digo',
              solution: 'Defina debug=False em produ√ß√£o ou use vari√°veis de ambiente'
            },
            'B105': {
              title: 'Hardcoded password/secret',
              risk: 'Credenciais expostas no c√≥digo-fonte',
              solution: 'Use vari√°veis de ambiente ou gerenciadores de secrets (ex: python-dotenv, AWS Secrets Manager)'
            },
            'B106': {
              title: 'Hardcoded password em argumento de fun√ß√£o',
              risk: 'Senha vis√≠vel no c√≥digo',
              solution: 'Carregue senhas de vari√°veis de ambiente ou arquivos de configura√ß√£o seguros'
            },
            'B107': {
              title: 'Hardcoded password em default de argumento',
              risk: 'Valor padr√£o inseguro',
              solution: 'Use None como padr√£o e carregue o valor de forma segura'
            },
            'B110': {
              title: 'Try/Except com pass',
              risk: 'Erros silenciados podem ocultar problemas de seguran√ßa',
              solution: 'Trate exce√ß√µes espec√≠ficas e fa√ßa log apropriado'
            },
            'B301': {
              title: 'Uso de pickle',
              risk: 'Deserializa√ß√£o insegura pode executar c√≥digo arbitr√°rio',
              solution: 'Use JSON ou outros formatos seguros. Se necess√°rio, valide dados antes de unpickle'
            },
            'B303': {
              title: 'Uso de MD5 ou SHA1',
              risk: 'Algoritmos de hash quebrados',
              solution: 'Use SHA-256, SHA-384 ou SHA-512 para hashing criptogr√°fico'
            },
            'B304': {
              title: 'Uso de cipher inseguro',
              risk: 'Criptografia fraca',
              solution: 'Use AES-256 com modo GCM ou outras cifras modernas'
            },
            'B501': {
              title: 'Certificado SSL n√£o verificado',
              risk: 'Permite ataques man-in-the-middle',
              solution: 'Defina verify=True em requests ou valide certificados manualmente'
            },
            'B601': {
              title: 'Uso de shell=True',
              risk: 'Inje√ß√£o de comandos no shell',
              solution: 'Use lista de argumentos sem shell=True, ou valide/escape entradas'
            },
            'B602': {
              title: 'Uso de subprocess sem valida√ß√£o',
              risk: 'Execu√ß√£o de comandos perigosos',
              solution: 'Valide todas as entradas e use shlex.quote() para escapar'
            },
            'B605': {
              title: 'Start process com shell',
              risk: 'Inje√ß√£o de comandos',
              solution: 'N√£o use shell=True e valide argumentos'
            },
            'B608': {
              title: 'SQL concatenado',
              risk: 'Inje√ß√£o SQL',
              solution: 'Use queries parametrizadas ou ORM (SQLAlchemy, Django ORM)'
            }
          };
          
          // Processar relat√≥rio do Bandit
          try {
            const bandit = JSON.parse(fs.readFileSync('bandit-report.json', 'utf8'));
            const highMedium = bandit.results.filter(r => ['HIGH', 'MEDIUM'].includes(r.issue_severity));
            
            if (highMedium.length > 0) {
              const high = highMedium.filter(r => r.issue_severity === 'HIGH').length;
              const medium = highMedium.filter(r => r.issue_severity === 'MEDIUM').length;
              
              issuesFound.push(`**Bandit:** ${highMedium.length} problema(s) de seguran√ßa no c√≥digo`);
              
              detailedInfo.push('#### üîç An√°lise Est√°tica de C√≥digo (Bandit)\n');
              if (high > 0) detailedInfo.push(`- üî¥ **${high}** problema(s) de severidade ALTA`);
              if (medium > 0) detailedInfo.push(`- üü° **${medium}** problema(s) de severidade M√âDIA`);
              
              detailedInfo.push('\n---\n');
              
              highMedium.slice(0, 8).forEach((issue, idx) => {
                const severity = issue.issue_severity === 'HIGH' ? 'üî¥ ALTA' : 'üü° M√âDIA';
                const solution = banditSolutions[issue.test_id] || {};
                
                detailedInfo.push(`### ${idx + 1}. ${severity} - ${solution.title || issue.issue_text}\n`);
                detailedInfo.push(`**üìç Localiza√ß√£o:** \`${issue.filename}:${issue.line_number}\``);
                detailedInfo.push(`**üîñ ID:** ${issue.test_id} | **‚ö†Ô∏è Confian√ßa:** ${issue.issue_confidence}\n`);
                
                if (solution.risk) {
                  detailedInfo.push(`**‚ö†Ô∏è Risco:**`);
                  detailedInfo.push(`${solution.risk}\n`);
                }
                
                detailedInfo.push(`**üìù Problema detectado:**`);
                detailedInfo.push('```python');
                detailedInfo.push(issue.code ? issue.code.trim() : 'C√≥digo n√£o dispon√≠vel');
                detailedInfo.push('```\n');
                
                if (solution.solution) {
                  detailedInfo.push(`**‚úÖ Solu√ß√£o recomendada:**`);
                  detailedInfo.push(`${solution.solution}\n`);
                  
                  // Adicionar exemplo de corre√ß√£o baseado no tipo
                  if (issue.test_id === 'B105' || issue.test_id === 'B106' || issue.test_id === 'B107') {
                    detailedInfo.push('**Exemplo de corre√ß√£o:**');
                    detailedInfo.push('```python');
                    detailedInfo.push('# Errado:');
                    detailedInfo.push('password = "minhasenha123"');
                    detailedInfo.push('');
                    detailedInfo.push('# Correto:');
                    detailedInfo.push('import os');
                    detailedInfo.push('password = os.environ.get("DB_PASSWORD")');
                    detailedInfo.push('```');
                  } else if (issue.test_id === 'B608') {
                    detailedInfo.push('**Exemplo de corre√ß√£o:**');
                    detailedInfo.push('```python');
                    detailedInfo.push('# Errado:');
                    detailedInfo.push('query = f"SELECT * FROM users WHERE id = {user_id}"');
                    detailedInfo.push('');
                    detailedInfo.push('# Correto:');
                    detailedInfo.push('query = "SELECT * FROM users WHERE id = %s"');
                    detailedInfo.push('cursor.execute(query, (user_id,))');
                    detailedInfo.push('```');
                  } else if (issue.test_id === 'B601' || issue.test_id === 'B602') {
                    detailedInfo.push('**Exemplo de corre√ß√£o:**');
                    detailedInfo.push('```python');
                    detailedInfo.push('# Errado:');
                    detailedInfo.push('subprocess.call(f"ls {user_input}", shell=True)');
                    detailedInfo.push('');
                    detailedInfo.push('# Correto:');
                    detailedInfo.push('subprocess.call(["ls", user_input], shell=False)');
                    detailedInfo.push('```');
                  } else if (issue.test_id === 'B303') {
                    detailedInfo.push('**Exemplo de corre√ß√£o:**');
                    detailedInfo.push('```python');
                    detailedInfo.push('# Errado:');
                    detailedInfo.push('import hashlib');
                    detailedInfo.push('hash = hashlib.md5(data).hexdigest()');
                    detailedInfo.push('');
                    detailedInfo.push('# Correto:');
                    detailedInfo.push('import hashlib');
                    detailedInfo.push('hash = hashlib.sha256(data).hexdigest()');
                    detailedInfo.push('```');
                  }
                } else {
                  detailedInfo.push(`**üí° Recomenda√ß√£o:**`);
                  detailedInfo.push(`Revise o c√≥digo e consulte a [documenta√ß√£o do Bandit](https://bandit.readthedocs.io/en/latest/plugins/${issue.test_id.toLowerCase()}.html) para orienta√ß√µes espec√≠ficas.\n`);
                }
                
                detailedInfo.push('\n---\n');
              });
              
              if (highMedium.length > 8) {
                detailedInfo.push(`\nüìã **H√° mais ${highMedium.length - 8} problema(s).** Baixe o relat√≥rio completo nos artifacts do workflow para an√°lise detalhada.\n`);
              }
            }
          } catch (e) {
            console.log('Erro ao processar Bandit:', e.message);
          }
          
          // Processar relat√≥rio do Safety
          try {
            const safety = JSON.parse(fs.readFileSync('safety-report.json', 'utf8'));
            if (safety.vulnerabilities && safety.vulnerabilities.length > 0) {
              issuesFound.push(`**Safety:** ${safety.vulnerabilities.length} vulnerabilidade(s) em depend√™ncias`);
              
              detailedInfo.push('\n#### üì¶ Vulnerabilidades em Depend√™ncias (Safety)\n');
              detailedInfo.push('Depend√™ncias com vulnerabilidades conhecidas (CVEs):\n');
              detailedInfo.push('---\n');
              
              safety.vulnerabilities.slice(0, 8).forEach((vuln, idx) => {
                const severity = vuln.severity || 'UNKNOWN';
                const severityEmoji = severity === 'HIGH' ? 'üî¥' : severity === 'MEDIUM' ? 'üü°' : '‚ö™';
                
                detailedInfo.push(`### ${idx + 1}. ${severityEmoji} ${vuln.package_name} ${vuln.vulnerable_spec || ''}\n`);
                
                detailedInfo.push(`**üîñ CVE ID:** ${vuln.vulnerability_id || 'N√£o informado'}`);
                if (vuln.published_date) {
                  detailedInfo.push(`**üìÖ Publicado em:** ${vuln.published_date}`);
                }
                detailedInfo.push('');
                
                detailedInfo.push(`**‚ö†Ô∏è Descri√ß√£o da Vulnerabilidade:**`);
                detailedInfo.push(`${vuln.advisory || 'Sem descri√ß√£o dispon√≠vel'}\n`);
                
                if (vuln.cve) {
                  detailedInfo.push(`**üîó Refer√™ncias:**`);
                  detailedInfo.push(`- [CVE Details](https://cve.mitre.org/cgi-bin/cvename.cgi?name=${vuln.cve})`);
                  detailedInfo.push(`- [NVD Database](https://nvd.nist.gov/vuln/detail/${vuln.cve})`);
                  detailedInfo.push('');
                }
                
                detailedInfo.push(`**‚úÖ Como Corrigir:**`);
                if (vuln.fixed_in && vuln.fixed_in.length > 0) {
                  detailedInfo.push(`Atualize o pacote para uma das vers√µes seguras:`);
                  detailedInfo.push('```bash');
                  detailedInfo.push(`pip install --upgrade "${vuln.package_name}>=${vuln.fixed_in[0]}"`);
                  detailedInfo.push('```');
                  detailedInfo.push(`**Vers√µes seguras:** ${vuln.fixed_in.join(', ')}`);
                } else {
                  detailedInfo.push(`‚ö†Ô∏è  Nenhuma vers√£o corrigida dispon√≠vel ainda.`);
                  detailedInfo.push(`**A√ß√µes poss√≠veis:**`);
                  detailedInfo.push(`- Procure por alternativas ao pacote`);
                  detailedInfo.push(`- Aguarde atualiza√ß√£o do mantenedor`);
                  detailedInfo.push(`- Avalie se o risco √© aceit√°vel para seu caso de uso`);
                }
                
                detailedInfo.push('');
                detailedInfo.push(`**üìù Atualize seu requirements.txt:**`);
                detailedInfo.push('```txt');
                if (vuln.fixed_in && vuln.fixed_in.length > 0) {
                  detailedInfo.push(`${vuln.package_name}>=${vuln.fixed_in[0]}  # Corrigido`);
                } else {
                  detailedInfo.push(`# ${vuln.package_name}  # ATEN√á√ÉO: Vulnerabilidade sem corre√ß√£o`);
                }
                detailedInfo.push('```\n');
                
                detailedInfo.push('---\n');
              });
              
              if (safety.vulnerabilities.length > 8) {
                detailedInfo.push(`\nüìã **H√° mais ${safety.vulnerabilities.length - 8} vulnerabilidade(s).** Baixe o relat√≥rio completo nos artifacts do workflow.\n`);
              }
            }
          } catch (e) {
            console.log('Erro ao processar Safety:', e.message);
          }
          
          // Processar relat√≥rio do pip-audit
          try {
            const pipAudit = JSON.parse(fs.readFileSync('pip-audit-report.json', 'utf8'));
            if (pipAudit.dependencies && pipAudit.dependencies.length > 0) {
              const vulnCount = pipAudit.dependencies.reduce((sum, dep) => sum + (dep.vulns || []).length, 0);
              if (vulnCount > 0) {
                issuesFound.push(`**pip-audit:** ${vulnCount} vulnerabilidade(s) adicionais`);
              }
            }
          } catch (e) {
            console.log('Erro ao processar pip-audit:', e.message);
          }
          
          if (issuesFound.length > 0) {
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security-vulnerability'
            });
            
            if (issues.length === 0) {
              const body = '## üîí An√°lise de Seguran√ßa - Vulnerabilidades Detectadas\n\n' +
                '> ‚ö†Ô∏è **ATEN√á√ÉO:** Vulnerabilidades de seguran√ßa foram encontradas durante a an√°lise da tag/release.\n\n' +
                '### üìä Resumo\n\n' +
                issuesFound.map(i => `- ${i}`).join('\n') + '\n\n' +
                '### üìã Detalhes das Vulnerabilidades\n\n' +
                detailedInfo.join('\n') + '\n\n' +
                '### üîó Informa√ß√µes do Workflow\n\n' +
                `- **Tag:** \`${{ github.ref_name }}\`\n` +
                `- **Commit:** \`${{ github.sha }}\`\n` +
                `- **Workflow Run:** [Ver detalhes](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n` +
                `- **Relat√≥rios completos:** Dispon√≠veis nos artifacts do workflow\n\n` +
                '### ‚úÖ A√ß√µes Recomendadas - Passo a Passo\n\n' +
                '#### 1Ô∏è‚É£ An√°lise Inicial\n' +
                '```bash\n' +
                '# Baixe os relat√≥rios completos dos artifacts do workflow\n' +
                '# Links dispon√≠veis acima em "Informa√ß√µes do Workflow"\n' +
                '```\n\n' +
                '#### 2Ô∏è‚É£ Corre√ß√£o de Vulnerabilidades em Depend√™ncias\n' +
                '```bash\n' +
                '# Liste as depend√™ncias desatualizadas\n' +
                'pip list --outdated\n\n' +
                '# Atualize pacotes espec√≠ficos (veja detalhes acima)\n' +
                'pip install --upgrade <pacote>>=<versao-segura>\n\n' +
                '# Atualize requirements.txt\n' +
                'pip freeze > requirements.txt\n\n' +
                '# Teste a aplica√ß√£o\n' +
                'pytest\n' +
                '```\n\n' +
                '#### 3Ô∏è‚É£ Corre√ß√£o de Problemas no C√≥digo\n' +
                '```bash\n' +
                '# Execute o Bandit localmente para verificar\n' +
                'pip install bandit\n' +
                'bandit -r . -f screen\n\n' +
                '# Corrija os problemas identificados (veja solu√ß√µes acima)\n' +
                '# Execute novamente para validar\n' +
                'bandit -r . -ll  # Apenas HIGH e MEDIUM\n' +
                '```\n\n' +
                '#### 4Ô∏è‚É£ Valida√ß√£o das Corre√ß√µes\n' +
                '```bash\n' +
                '# Execute testes de seguran√ßa localmente\n' +
                'pip install safety bandit pip-audit\n\n' +
                '# Verifique depend√™ncias\n' +
                'safety check\n' +
                'pip-audit\n\n' +
                '# Verifique c√≥digo\n' +
                'bandit -r . -ll\n' +
                '```\n\n' +
                '#### 5Ô∏è‚É£ Commit e Nova Tag\n' +
                '```bash\n' +
                '# Fa√ßa commit das corre√ß√µes\n' +
                'git add .\n' +
                'git commit -m "fix: corrige vulnerabilidades de seguran√ßa"\n' +
                'git push origin main\n\n' +
                '# Crie nova tag ap√≥s valida√ß√£o\n' +
                'git tag v<nova-versao>\n' +
                'git push origin v<nova-versao>\n' +
                '```\n\n' +
                '### üìö Recursos\n\n' +
                '- [OWASP Top 10](https://owasp.org/www-project-top-ten/)\n' +
                '- [Python Security Best Practices](https://python.readthedocs.io/en/stable/library/security_warnings.html)\n' +
                '- [Bandit Documentation](https://bandit.readthedocs.io/)\n' +
                '- [Safety DB](https://github.com/pyupio/safety-db)\n\n' +
                '_Issue criada automaticamente pelo workflow de seguran√ßa._';
              
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `üîí Vulnerabilidades de Seguran√ßa - Tag ${{ github.ref_name }}`,
                body: body,
                labels: ['security-vulnerability', 'priority-critical']
              });
            }
          }
