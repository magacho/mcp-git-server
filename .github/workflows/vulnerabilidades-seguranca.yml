name: Testes de Vulnerabilidades e Seguranca

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  issues: write

jobs:
  security:
    name: An√°lise de Seguran√ßa
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install safety bandit pip-audit
    
    - name: Run Bandit Security Scan
      run: |
        bandit -r . -f json -o bandit-report.json || true
        bandit -r . -f txt
      continue-on-error: true
    
    - name: Run Safety Check
      run: |
        safety check --json --output safety-report.json || true
        safety check || true
      continue-on-error: true
    
    - name: Run pip-audit
      run: |
        pip-audit --format json --output pip-audit-report.json || true
        pip-audit || true
      continue-on-error: true
    
    - name: Upload security reports
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json
          pip-audit-report.json
    
    - name: Evaluate security results
      id: evaluate
      run: |
        HAS_ISSUES=false
        
        if [ -f bandit-report.json ]; then
          BANDIT_ISSUES=$(python -c "import json; data=json.load(open('bandit-report.json')); print(len([r for r in data.get('results', []) if r.get('issue_severity') in ['HIGH', 'MEDIUM']]))")
          echo "Bandit encontrou $BANDIT_ISSUES problemas"
          if [ "$BANDIT_ISSUES" -gt "0" ]; then
            HAS_ISSUES=true
          fi
        fi
        
        if [ -f safety-report.json ]; then
          SAFETY_ISSUES=$(python -c "import json; data=json.load(open('safety-report.json')); print(len(data.get('vulnerabilities', [])))" 2>/dev/null || echo "0")
          echo "Safety encontrou $SAFETY_ISSUES vulnerabilidades"
          if [ "$SAFETY_ISSUES" -gt "0" ]; then
            HAS_ISSUES=true
          fi
        fi
        
        echo "has_issues=$HAS_ISSUES" >> $GITHUB_OUTPUT
    
    - name: Create security issue
      if: steps.evaluate.outputs.has_issues == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          let issuesFound = [];
          
          try {
            const bandit = JSON.parse(fs.readFileSync('bandit-report.json', 'utf8'));
            const highMedium = bandit.results.filter(r => ['HIGH', 'MEDIUM'].includes(r.issue_severity));
            if (highMedium.length > 0) {
              issuesFound.push(`**Bandit:** ${highMedium.length} problemas de seguran√ßa encontrados`);
            }
          } catch (e) {}
          
          try {
            const safety = JSON.parse(fs.readFileSync('safety-report.json', 'utf8'));
            if (safety.vulnerabilities && safety.vulnerabilities.length > 0) {
              issuesFound.push(`**Safety:** ${safety.vulnerabilities.length} vulnerabilidades em depend√™ncias`);
            }
          } catch (e) {}
          
          if (issuesFound.length > 0) {
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security-vulnerability'
            });
            
            if (issues.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'üîí Vulnerabilidades de Seguran√ßa Detectadas',
                body: '## An√°lise de Seguran√ßa - Problemas Encontrados\n\n' +
                  '**Tag:** ${{ github.ref_name }}\n' +
                  '**Commit:** ${{ github.sha }}\n' +
                  '**Workflow:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n\n' +
                  '### Problemas Detectados:\n' +
                  issuesFound.join('\n') + '\n\n' +
                  'Por favor, revise os relat√≥rios de seguran√ßa e corrija as vulnerabilidades identificadas.',
                labels: ['security-vulnerability', 'priority-critical']
              });
            }
          }
