name: Coverage Analysis & Suggestions

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  workflow_dispatch: # Manual trigger

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  analyze-coverage:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          pip install pytest pytest-cov coverage
          pip install -r requirements.txt || echo "No requirements.txt found"
      
      - name: Run tests with coverage
        continue-on-error: true
        run: |
          pytest --cov=. --cov-report=json --cov-report=term-missing --cov-report=html > coverage_output.txt 2>&1 || true
          cat coverage_output.txt
      
      - name: Generate coverage report
        id: coverage
        run: |
          if [ -f .coverage ]; then
            COVERAGE_PCT=$(coverage report | grep TOTAL | awk '{print $4}' | sed 's/%//')
            echo "coverage_pct=$COVERAGE_PCT" >> $GITHUB_OUTPUT
            echo "Coverage: $COVERAGE_PCT%"
            
            # Generate detailed report
            coverage report -m > detailed_coverage.txt
            
            # Extract uncovered files
            coverage json
            python3 << 'PYTHON'
          import json
          
          with open('coverage.json', 'r') as f:
              data = json.load(f)
          
          uncovered = []
          for file, info in data['files'].items():
              if file.startswith('test_'):
                  continue
              coverage = info['summary']['percent_covered']
              if coverage < 80:
                  missing = len(info['missing_lines'])
                  uncovered.append(f"- `{file}`: {coverage:.1f}% coverage ({missing} lines missing)")
          
          if uncovered:
              print("UNCOVERED_FILES<<EOF")
              print("\n".join(uncovered))
              print("EOF")
          else:
              print("UNCOVERED_FILES=âœ… All files have > 80% coverage")
          PYTHON
          else
            echo "coverage_pct=0" >> $GITHUB_OUTPUT
            echo "UNCOVERED_FILES=âš ï¸ No coverage data generated" >> $GITHUB_OUTPUT
          fi
      
      - name: Analyze uncovered code
        if: steps.coverage.outputs.coverage_pct < 80
        run: |
          python3 .github/scripts/suggest_tests.py > test_suggestions.txt 2>&1 || echo "Script execution failed"
          cat test_suggestions.txt
      
      - name: Create test suggestions report
        if: steps.coverage.outputs.coverage_pct < 80
        run: |
          cat > test_report.md << 'EOF'
          ## ðŸ§ª Test Coverage Analysis
          
          **Current Coverage:** ${{ steps.coverage.outputs.coverage_pct }}%
          **Target:** 80%
          **Status:** âš ï¸ Below target
          
          ### ðŸ“Š Files Needing Tests:
          
          ${{ env.UNCOVERED_FILES }}
          
          ### ðŸ’¡ Suggested Actions:
          
          1. Review the functions with low coverage
          2. Add test cases for critical paths
          3. Focus on error handling and edge cases
          
          ### ðŸ“ Test Suggestions:
          
          ```
          $(cat test_suggestions.txt 2>/dev/null || echo "Run locally: pytest --cov=. --cov-report=term-missing")
          ```
          
          ---
          *Generated automatically by Test Coverage CI*
          EOF
          
          cat test_report.md
      
      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            htmlcov/
            coverage.json
            detailed_coverage.txt
            test_suggestions.txt
            test_report.md
      
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            let body = '## ðŸ§ª Test Coverage Report\n\n';
            
            try {
              const report = fs.readFileSync('test_report.md', 'utf8');
              body += report;
            } catch (e) {
              body += 'âœ… Coverage looks good!\n\n';
              body += `**Coverage:** ${{ steps.coverage.outputs.coverage_pct }}%`;
            }
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Test Coverage Report')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
      
      - name: Create issue for low coverage
        if: steps.coverage.outputs.coverage_pct < 70 && github.event_name == 'push'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            let body = '## ðŸ”´ Critical: Test Coverage Below 70%\n\n';
            body += `**Current Coverage:** ${{ steps.coverage.outputs.coverage_pct }}%\n`;
            body += `**Minimum Required:** 70%\n\n`;
            
            try {
              const report = fs.readFileSync('test_report.md', 'utf8');
              body += report;
            } catch (e) {
              body += 'Please review uncovered code and add tests.\n';
            }
            
            // Check if similar issue exists
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'test-coverage'
            });
            
            if (issues.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸ§ª Test Coverage Below 70% (${{ steps.coverage.outputs.coverage_pct }}%)`,
                body: body,
                labels: ['test-coverage', 'tech-debt', 'priority-high']
              });
            }
      
      - name: Fail if coverage too low
        if: steps.coverage.outputs.coverage_pct < 50
        run: |
          echo "âŒ CRITICAL: Coverage is below 50% (${{ steps.coverage.outputs.coverage_pct }}%)"
          echo "This is blocking. Please add tests before merging."
          exit 1
